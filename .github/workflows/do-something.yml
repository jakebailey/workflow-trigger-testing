name: Do something

on:
  workflow_dispatch:
    inputs:
      arg:
        description: 'An argument'
        required: true
        default: ''

      # For bot trigger
      distinct_id:
        description: '(bot) A distinct ID'
        required: false
        default: ''
      issue_number:
        description: '(bot) An issue number'
        required: false
        default: ''
      status_comment_id:
        description: '(bot) A comment ID'
        required: false
        default: ''

run-name: ${{ github.workflow }}${{ inputs.distinct_id && format(' (bot run {0})', inputs.distinct_id) || '' }}

permissions:
  contents: read
  issues: write

# Ensure scripts are run with pipefail. See:
# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - run: |
          sleep 20

      - run: |
          echo "Running with arg: ${{ inputs.arg }}"

      - uses: actions/github-script@v7
        env:
          DISTINCT_ID: ${{ inputs.distinct_id }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          STATUS_COMMENT_ID: ${{ inputs.status_comment_id }}
          ARG: ${{ inputs.arg }}
        with:
          script: |
            const { DISTINCT_ID, ISSUE_NUMBER, STATUS_COMMENT_ID, ARG } = process.env;
            // Post results
            const resultsComment = await github.rest.issues.createComment({
              issue_number: +ISSUE_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `The results for ${ARG} are in!`,
            });

            const toReplace = `<!--result-${DISTINCT_ID}-->`;
            while (true) {
              // Get status comment contents
              const statusComment = await github.rest.issues.getComment({
                comment_id: +STATUS_COMMENT_ID,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const oldComment = statusComment.data.body;
              if (!oldComment.includes(toReplace)) {
                break;
              }

              const newComment = oldComment.replace(
                toReplace,
                `[Results](${resultsComment.data.html_url})`,
              )

              // Update status comment
              await github.rest.issues.updateComment({
                comment_id: +STATUS_COMMENT_ID,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newComment,
              });

              // Repeat; someone may have edited the comment at the same time.
              await new Promise((resolve) => setTimeout(resolve, 1000));
            }
        if: ${{ inputs.distinct_id }}
